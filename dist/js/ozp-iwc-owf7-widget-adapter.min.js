var gadgets=gadgets||{};gadgets.util=function(){function a(){var a,b=document.location.href,c=b.indexOf("?"),d=b.indexOf("#");return a=-1===d?b.substr(c+1):[b.substr(c+1,d-c-1),"&",b.substr(d+1)].join(""),a.split("&")}function b(a,b){return String.fromCharCode(b)}function c(a){e=a["core.util"]||{}}var d=null,e={},f=[],g={0:!1,10:!0,13:!0,34:!0,39:!0,60:!0,62:!0,92:!0,8232:!0,8233:!0};return gadgets.config&&gadgets.config.register("core.util",null,c),{getUrlParameters:function(){if(null!==d)return d;d={};for(var b=a(),c=window.decodeURIComponent?decodeURIComponent:unescape,e=0,f=b.length;f>e;++e){var g=b[e].indexOf("=");if(-1!==g){var h=b[e].substring(0,g),i=b[e].substring(g+1);i=i.replace(/\+/g," "),d[h]=c(i)}}return d},makeClosure:function(a,b,c){for(var d=[],e=2,f=arguments.length;f>e;++e)d.push(arguments[e]);return function(){for(var c=d.slice(),e=0,f=arguments.length;f>e;++e)c.push(arguments[e]);return b.apply(a,c)}},makeEnum:function(a){for(var b,c={},d=0;b=a[d];++d)c[b]=b;return c},getFeatureParameters:function(a){return"undefined"==typeof e[a]?null:e[a]},hasFeature:function(a){return"undefined"!=typeof e[a]},registerOnLoadHandler:function(a){f.push(a)},runOnLoadHandlers:function(){for(var a=0,b=f.length;b>a;++a)f[a]()},escape:function(a,b){if(!a)return a;if("string"==typeof a)return gadgets.util.escapeString(a);if("array"==typeof a)for(var c=0,d=a.length;d>c;++c)a[c]=gadgets.util.escape(a[c]);else if("object"==typeof a&&b){var e={};for(var f in a)a.hasOwnProperty(f)&&(e[gadgets.util.escapeString(f)]=gadgets.util.escape(a[f],!0));return e}return a},escapeString:function(a){for(var b,c,d=[],e=0,f=a.length;f>e;++e)b=a.charCodeAt(e),c=g[b],c===!0?d.push("&#",b,";"):c!==!1&&d.push(a.charAt(e));return d.join("")},unescapeString:function(a){return a.replace(/&#([0-9]+);/g,b)}}}(),gadgets.util.getUrlParameters();var gadgets=gadgets||{};gadgets.json=function(){function f(a){return 10>a?"0"+a:a}return Date.prototype.toJSON=function(){return[this.getUTCFullYear(),"-",f(this.getUTCMonth()+1),"-",f(this.getUTCDate()),"T",f(this.getUTCHours()),":",f(this.getUTCMinutes()),":",f(this.getUTCSeconds()),"Z"].join("")},{stringify:function(a){return JSON.stringify(a)},parse:function(text){return"string"==typeof text&&/^[\],:{}\s]*$/.test(text.replace(/\\["\\\/b-u]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?eval("("+text+")"):!1}}}();var gadgets=gadgets||{};gadgets.rpc=function(){function a(){return"function"==typeof window.postMessage?"wpm":"object"==typeof window.postMessage?"wpm":"function"==typeof document.postMessage?"dpm":window.ActiveXObject?"nix":"Gecko"===navigator.product?"fe":"ifpc"}function b(){if("dpm"===L||"wpm"===L){var a=function(a){var b=null;try{b=gadgets.json.parse(a.data)}catch(c){}b&&f(b)};window.opener&&(window.opener.parent&&(window.opener.parent.addEventListener("message",a,!1),window.addEventListener("beforeunload",function(){window.opener.parent.removeEventListener("message",a)})),window.opener.addEventListener("message",a,!1)),"undefined"!=typeof window.addEventListener?window.addEventListener("message",a,!1):"undefined"!=typeof window.attachEvent&&window.attachEvent("onmessage",a)}if("nix"===L&&"unknown"!=typeof window[u]){window[v]=function(a){f(gadgets.json.parse(a))},window[w]=function(a,b,c){C[a]==c&&(x[a]=b)};var b="Class "+t+"\n Private m_Intended\nPrivate m_Auth\nPublic Sub SetIntendedName(name)\n If isEmpty(m_Intended) Then\nm_Intended = name\nEnd If\nEnd Sub\nPublic Sub SetAuth(auth)\n If isEmpty(m_Auth) Then\nm_Auth = auth\nEnd If\nEnd Sub\nPublic Sub SendMessage(data)\n "+v+"(data)\nEnd Sub\nPublic Function GetAuthToken()\n GetAuthToken = m_Auth\nEnd Function\nPublic Sub CreateChannel(channel, auth)\n Call "+w+"(m_Intended, channel, auth)\nEnd Sub\nEnd Class\nFunction "+u+"(name, auth)\nDim wrap\nSet wrap = New "+t+"\nwrap.SetIntendedName name\nwrap.SetAuth auth\nSet "+u+" = wrap\nEnd Function";try{window.execScript(b,"vbscript")}catch(c){L="ifpc"}}}function c(a){if("{"!=a.charAt(0))return a;{var b=gadgets.json.parse(a);b.id}return gadgets.json.stringify({id:b.id})}function d(a,b){if(!F[a]){if("fe"===L)try{var c=document.getElementById(a);c[r]=function(a){f(gadgets.json.parse(a))}}catch(d){}if("nix"===L)try{var c=document.getElementById(a),e=window[u](a,b);c.contentWindow.opener=e}catch(d){}F[a]=!0}}function e(a){for(var b=gadgets.json.stringify,c=[],d=0,e=a.length;e>d;++d)c.push(encodeURIComponent(b(a[d])));return c.join("&")}function f(a){if(a&&"string"==typeof a.s&&"string"==typeof a.f&&a.a instanceof Array){if(a.f=c(a.f),C[a.f]&&C[a.f]!=a.t)throw new Error("Invalid auth token.");a.c&&(a.callback=function(b){gadgets.rpc.call(a.f,p,null,a.c,b)});var b=(y[a.s]||y[q]).apply(a,a.a);a.c&&"undefined"!=typeof b&&gadgets.rpc.call(a.f,p,null,a.c,b)}}function g(a,b,c,d){try{if(".."!=c){var e=x[".."];if(!e&&window.opener&&"GetAuthToken"in window.opener&&(e=window.opener,e.GetAuthToken()==C[".."])){var f=C[".."];e.CreateChannel(window[u]("..",f),f),x[".."]=e,window.opener=null}if(e)return void e.SendMessage(d)}else if(x[a])return void x[a].SendMessage(d)}catch(g){}i(a,b,c,d)}function h(a,b,c,d,e){try{if(".."!=c){var g=window.frameElement;if("function"==typeof g[r])return"function"!=typeof g[r][s]&&(g[r][s]=function(a){f(gadgets.json.parse(a))}),void g[r](d)}else{var h=document.getElementById(a);if("function"==typeof h[r]&&"function"==typeof h[r][s])return void h[r][s](d)}}catch(j){}i(a,b,c,d,e)}function i(a,b,c,d,f){var g=gadgets.rpc.getRelayUrl(a);if(!g)throw new Error("No relay file assigned for IFPC");var h=null,i=[];if(B[a])h=[g,"#",e([c,D,1,0,e([c,b,"","",c].concat(f))])].join(""),i.push(h);else if(h=[g,"#",encodeURIComponent(a),"&",c,"@",D,"&"].join(""),K[a])for(var j,k=encodeURIComponent(d),m=I-h.length,n=Math.ceil(k.length/m),o=0;k.length>0;)j=k.substring(0,m),k=k.substring(m),i.push([h,n,"&",o,"&",j].join("")),o+=1;else i.push([h,1,"&",0,"&",,encodeURIComponent(d)].join(""));do l(i.shift(),a);while(i.length>0);return!0}function j(a){if(!a)return!1;if(".."==a)return!1;var b=document.getElementById(a);return b?!1:"undefined"==typeof _childWindows?!1:!0}function k(a,b){for(var c=b-1;c>=0;--c)if("undefined"==typeof a[c])return!1;return!0}function l(a,b){if(j(b)){var c=window._childWindowMessageId;return c++,window._childWindowMessageQueue.push({id:c,target:b,src:a}),window._childWindowMessageId++,void(window._childWindowMessageQueue.length>20&&window._childWindowMessageQueue.shift())}for(var d,e=z.length-1;e>=0;--e){var f=z[e];try{if(f&&(f.recyclable||"complete"===f.readyState)){if(f.parentNode.removeChild(f),!window.ActiveXObject){f.recyclable=!1,d=f;break}z[e]=f=null,z.splice(e,1)}}catch(g){}}d||(d=document.createElement("iframe"),d.style.border=d.style.width=d.style.height="0px",d.style.visibility="hidden",d.style.position="absolute",d.onload=function(){this.recyclable=!0},z.push(d)),d.src=a,setTimeout(function(){document.body.appendChild(d)},0)}function m(a){if("undefined"==typeof a||".."===a){try{if(G[a]!==!1&&window.parent.opener)return window.parent.opener.parent}catch(b){}return window.parent}a=String(a);var c=null;if(c=document.getElementById(a),c&&c.contentWindow)return c.contentWindow;if("undefined"!=typeof _childWindows)for(var d=0;d<_childWindows.length;d++){var e=_childWindows[d];try{e.document&&(c=e.document.getElementById(a))}catch(b){}if(c&&c.contentWindow)return c.contentWindow}return null}function n(a,b){var c;if(G[a]!==!1){var d=m(a);try{c=d.gadgets.rpc.receiveSameDomain}catch(e){}}return"function"==typeof c?(c(b),G[a]=!0,!0):(G[a]=!1,!1)}function o(a){if("http://"===a.rpc.parentRelayUrl.substring(0,7))A[".."]=a.rpc.parentRelayUrl;else{for(var b,c=document.location.search.substring(0).split("&"),d="",e=0;b=c[e];++e)if(0===b.indexOf("parent=")){d=decodeURIComponent(b.substring(7));break}A[".."]=d+a.rpc.parentRelayUrl}B[".."]=!!a.rpc.useLegacyProtocol}var p="__cb",q="",r="__g2c_rpc",s="__c2g_rpc",t="GRPC____NIXVBS_wrapper",u="GRPC____NIXVBS_get_wrapper",v="GRPC____NIXVBS_handle_message",w="GRPC____NIXVBS_create_channel",x={},y={},z=[],A={},B={},C={},D=0,E={},F={},G={},H={};gadgets.util&&(H=gadgets.util.getUrlParameters()),C[".."]=H.rpctoken||H.ifpctok||0;var I=2e3,J={},K={},L=a();if(b(),y[q]=function(){},y[p]=function(a,b){var c=E[a];c&&(delete E[a],c(b))},window._childWindowMessageQueue=[],window._childWindowMessageId=0,window._getChildWindowMessage=function(a){for(var b=_childWindowMessageQueue,c=0;c<b.length;c++){var d=b[c];if(d.id==a)return d}},gadgets.config){var M={parentRelayUrl:gadgets.config.NonEmptyStringValidator};gadgets.config.register("rpc",M,o)}return{register:function(a,b){if(a==p)throw new Error("Cannot overwrite callback service");if(a==q)throw new Error("Cannot overwrite default service: use registerDefault");y[a]=b},unregister:function(a){if(a==p)throw new Error("Cannot delete callback service");if(a==q)throw new Error("Cannot delete default service: use unregisterDefault");delete y[a]},registerDefault:function(a){y[""]=a},unregisterDefault:function(){delete y[""]},call:function(a,b,d,e){++D,a=c(a)||"..",d&&(E[D]=d);var f="..";".."===a&&(f=c(window.name));var j={s:b,f:f,c:d?D:0,a:Array.prototype.slice.call(arguments,3),t:C[a]};if(!n(a,j)){var k=gadgets.json.stringify(j),l=L;switch(B[a]&&(l="ifpc"),l){case"dpm":var o=m(a),p=o.document;if(null!=p)try{p.postMessage(k)}catch(q){i(a,b,f,k,j.a)}break;case"wpm":var o=m(a);if(null!=o)try{o.postMessage(k,"*")}catch(q){i(a,b,f,k,j.a)}break;case"nix":g(a,b,f,k);break;case"fe":h(a,b,f,k,j.a);break;default:i(a,b,f,k,j.a)}}},getRelayUrl:function(a){return A[a]},setRelayUrl:function(a,b,c,d){A[a]=b,B[a]=!!c,K[a]=!!d},setAuthToken:function(a,b){C[a]=b,d(a,b)},getRelayChannel:function(){return L},receive:function(a){if(a.length>4){var b=a[1],c=parseInt(a[2],10),d=parseInt(a[3],10),e=a[a.length-1],g=1===c;c>1&&(J[b]||(J[b]=[]),J[b][d]=e,k(J[b],c)&&(e=J[b].join(""),delete J[b],g=!0)),g&&f(gadgets.json.parse(decodeURIComponent(e)))}},receiveSameDomain:function(a){a.a=Array.prototype.slice.call(a.a),window.setTimeout(function(){f(a)},0)}}}();var gadgets=gadgets||{};gadgets.json&&(gadgets.json.parse=function(text){return text&&text.replace&&/^[\],:{}\s]*$/.test(text.replace(/\\["\\\/b-u]/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))?eval("("+text+")"):!1}),ozpIwc=ozpIwc||{},ozpIwc.owf7BridgeModules=ozpIwc.owf7BridgeModules||{},ozpIwc.owf7BridgeModules.components=function(a){if(!a)throw"Needs to have an Owf7ParticipantListener";return{components:{keys:{_widget_iframe_ready:function(a){}},widget:{_WIDGET_LAUNCHER_CHANNEL:function(a,b,c){a.components.onLaunchWidget(b,c,this)}}}}},ozpIwc=ozpIwc||{},ozpIwc.owf7BridgeModules=ozpIwc.owf7BridgeModules||{},ozpIwc.owf7BridgeModules.dd=function(a){if(!a)throw"Needs to have an Owf7ParticipantListener";return{dd:{_fake_mouse_move:function(a,b){console.log(b),a.dd.onFakeMouseMoveFromClient(b)},_fake_mouse_up:function(a,b){a.dd.onFakeMouseUpFromClient(b)},_fake_mouse_out:function(a){}}}},ozpIwc=ozpIwc||{},ozpIwc.owf7BridgeModules=ozpIwc.owf7BridgeModules||{},ozpIwc.owf7BridgeModules.eventing=function(a){if(!a)throw"Needs to have an Owf7ParticipantListener";return{eventing:{container_init:function(a,b,c){a.eventing.onContainerInit(b,c)},pubsub:function(a,b,c,d,e){a.eventing.onPubsub(b,c,d,e,this.f)}}}},ozpIwc=ozpIwc||{},ozpIwc.owf7BridgeModules=ozpIwc.owf7BridgeModules||{},ozpIwc.owf7BridgeModules.intents=function(a){if(!a)throw"Needs to have an Owf7ParticipantListener";return{intents:{_intents:function(a,b,c,d,e){a.intents.onIntents(b,c,d,e,this)},_intents_receive:function(a,b,c){a.intents.onIntentsReceive(b,c)}}}},ozpIwc=ozpIwc||{},ozpIwc.owf7BridgeModules=ozpIwc.owf7BridgeModules||{},ozpIwc.owf7BridgeModules.kernel=function(a){if(!a)throw"Needs to have an Owf7ParticipantListener";return{kernel:{_getWidgetReady:function(a,b,c){a.kernel.onGetWidgetReady(b,this)},_widgetReady:function(a,b){a.kernel.onWidgetReady(b)},register_functions:function(a,b,c){a.kernel.onRegisterFunctions(b,c)},GET_FUNCTIONS:function(a,b,c){a.kernel.onGetFunctions(b,c,this)},FUNCTION_CALL:function(a,b,c,d,e){a.kernel.onFunctionCall(b,c,d,e)},FUNCTION_CALL_RESULT:function(a,b,c,d,e){a.kernel.onFunctionCallResult(b,c,d,e)},LIST_WIDGETS:function(a){a.kernel.onListWidgets(this)},DIRECT_MESSAGE:function(a,b,c){a.kernel.onDirectMessage(b,c)},ADD_EVENT:function(a,b,c){a.kernel.onAddEvent(b,c)},CALL_EVENT:function(a,b,c){a.kernel.onCallEvent(b,c)}}}},ozpIwc=ozpIwc||{},ozpIwc.owf7BridgeModules=ozpIwc.owf7BridgeModules||{},ozpIwc.owf7BridgeModules.util=function(a){if(!a)throw"Needs to have an Owf7ParticipantListener";return{util:{"Ozone.log":function(a,b){a.util.onOzoneLog(b)}}}},ozpIwc.Owf7Bridge=function(a){if(a=a||{},!a.listener)throw this._noListener_err;this.listener=a.listener,this.funcs={},this._defaultHandler=a.defaultHandler||this._defaultHandler,this._initHandlers(),this.addHandlers(a.funcs)},ozpIwc.Owf7Bridge.prototype._noListener_err="An Owf7ParticipantListener is required to bridge RPC to IWC",ozpIwc.Owf7Bridge.prototype.addHandlers=function(a){var b=ozpIwc.Owf7Bridge.objectCategoryFormat(a);this._registerFunctions(b)},ozpIwc.Owf7Bridge.prototype.removeHandlers=function(a){var b=ozpIwc.Owf7Bridge.objectCategoryFormat(a);this._unregisterFunctions(b)},ozpIwc.Owf7Bridge.prototype.updateHandlers=function(a,b){this.removeHandlers(a),this.addHandlers(b)},ozpIwc.Owf7Bridge.prototype.registerDefaultHandler=function(a){if("function"!=typeof a)throw"Owf7Bridge default handler must be a function.";gadgets.rpc.registerDefault(a)},ozpIwc.Owf7Bridge.prototype._registerFunctions=function(a){var b=this,c=function(a,c,d){function e(){var a=b.listener.getParticipant(this.f);a&&(Array.prototype.unshift.call(arguments,a),c.apply(this,arguments))}gadgets.rpc.register(d,e),a[d]=e};ozpIwc.Owf7Bridge.functionsInObjects({inObj:a,outObj:this.funcs,onFn:c})},ozpIwc.Owf7Bridge.prototype._unregisterFunctions=function(a){var b=function(a,b,c){gadgets.rpc.unregister(c,b),delete a[c]};ozpIwc.Owf7Bridge.functionsInObjects({inObj:a,outObj:this.funcs,onFn:b})},ozpIwc.Owf7Bridge.prototype._initHandlers=function(){var a=this;this._defaultHandler=function(){if(a.listener.getParticipant(this.f)){var b=function(a){return"[service:"+a.s+",from:"+a.f+"]:"+JSON.stringify(a.a)};console.log("Unknown rpc "+b(this))}},this.registerDefaultHandler(this._defaultHandler);for(var b in ozpIwc.owf7BridgeModules){var c=ozpIwc.owf7BridgeModules[b];ozpIwc.owf7BridgeModules.hasOwnProperty(b)&&"function"==typeof c&&this.addHandlers(c(this.listener))}return this.funcs},ozpIwc.Owf7Bridge.objectCategoryFormat=function(a){var b={uncategorized:{}};for(var c in a)a.hasOwnProperty(c)&&("function"==typeof a[c]?b.uncategorized[c]=a[c]:b[c]=a[c]);return b},ozpIwc.Owf7Bridge.functionsInObjects=function(a){function b(a,c,d,e){for(var f in a)a.hasOwnProperty(f)&&("function"==typeof a[f]?d(c,a[f],f):"object"==typeof a[f]?(c[f]=c[f]||{},b(a[f],c[f],d)):console.error("typeof("+f+")=",typeof a[f],". Only functions allowed."))}return a.inObj=a.inObj||{},a.outObj=a.outObj||{},a.onFn=a.onFn||function(){},b(a.inObj,a.outObj,a.onFn),a.outObj},ozpIwc=ozpIwc||{},ozpIwc.owf7ParticipantModules=ozpIwc.owf7ParticipantModules||{},ozpIwc.owf7ParticipantModules.Components=function(a){if(!a)throw"Needs to have an Owf7Participant";this.participant=a,this.systemApi=this.participant.client.system()},ozpIwc.owf7ParticipantModules.Components.prototype.onLaunchWidget=function(a,b,c){b=JSON.parse(b),this.systemApi.launch("/application/"+b.guid,{contentType:"text/plain",entity:b.data}).then(function(a){c.callback&&c.callback({error:!1,newWidgetLaunched:!0,uniqueId:"unknown,not supported yet"})})},ozpIwc=ozpIwc||{},ozpIwc.owf7ParticipantModules=ozpIwc.owf7ParticipantModules||{},ozpIwc.owf7ParticipantModules.Dd=function(a){if(!a)throw"Needs to have an Owf7Participant";this.participant=a,this.mouseOver=!0,this.lastPosition={},this.lastMouseMove=Date.now(),this.mouseMoveDelay=100,this.dataApi=this.participant.client.data(),this.registerDragAndDrop()},ozpIwc.owf7ParticipantModules.Dd.rpcChannel=function(a){return"/owf-legacy/gadgetsRpc/"+a},ozpIwc.owf7ParticipantModules.Dd.prototype.registerDragAndDrop=function(){var a=this;this.dataApi.watch(ozpIwc.owf7ParticipantModules.Dd.rpcChannel("_fake_mouse_up"),function(b){a.onFakeMouseUpFromOthers(b.entity.newValue)}),this.dataApi.watch(ozpIwc.owf7ParticipantModules.Dd.rpcChannel("_fake_mouse_move"),function(b){a.onFakeMouseMoveFromOthers(b.entity.newValue)})},ozpIwc.owf7ParticipantModules.Dd.prototype.onFakeMouseUpFromOthers=function(a){var b=this.convertToLocalCoordinates(a);this.inIframeBounds(b)&&gadgets.rpc.call(this.participant.rpcId,"_fire_mouse_up",null,b)},ozpIwc.owf7ParticipantModules.Dd.prototype.onFakeMouseMoveFromOthers=function(a){if("screenX"in a&&"screenY"in a&&(this.lastPosition=a,a.sender!==this.participant.rpcId)){var b=this.convertToLocalCoordinates(a);this.inIframeBounds(b)?(this.mouseOver=!0,gadgets.rpc.call(this.participant.rpcId,"_fire_mouse_move",null,b)):(this.mouseOver&&gadgets.rpc.call(this.participant.rpcId,"pubsub",null,"_dragOutName","..",null),this.mouseOver=!1)}},ozpIwc.owf7ParticipantModules.Dd.prototype.onFakeMouseMoveFromClient=function(a){this.lastPosition=a;var b=Date.now(),c=b-this.lastMouseMove;if(!(c<this.mouseMoveDelay)){var d=this.convertToLocalCoordinates(a);this.mouseOver=this.inIframeBounds(d),this.lastMouseMove=b,this.dataApi.set(ozpIwc.owf7ParticipantModules.Dd.rpcChannel("_fake_mouse_move"),{entity:a})}},ozpIwc.owf7ParticipantModules.Dd.prototype.onFakeMouseUpFromClient=function(a){this.dataApi.set(ozpIwc.owf7ParticipantModules.Dd.rpcChannel("_fake_mouse_up"),{entity:a})},ozpIwc.owf7ParticipantModules.Dd.prototype.inIframeBounds=function(a){return a.pageX>=0&&a.pageX<this.participant.iframe.clientWidth&&a.pageY>=0&&a.pageY<this.participant.iframe.clientHeight},ozpIwc.owf7ParticipantModules.Dd.prototype.convertToLocalCoordinates=function(a){for(var b=this.participant.listener.convertToLocalCoordinates(a),c=this.participant.iframe;c;)b.pageX+=c.offsetLeft-c.scrollLeft+c.clientLeft,b.pageY+=c.offsetTop-c.scrollTop+c.clientTop,c=c.offsetParent;return b},ozpIwc.owf7ParticipantModules.Dd.prototype.hookPublish_dragOutName=function(){return!1},ozpIwc.owf7ParticipantModules.Dd.prototype.hookPublish_dropReceiveData=function(){return!1},ozpIwc.owf7ParticipantModules.Dd.prototype.hookReceive_dragSendData=function(){return!1},ozpIwc.owf7ParticipantModules.Dd.prototype.hookReceive_dragOutName=function(){return!1},ozpIwc.owf7ParticipantModules.Dd.prototype.hookReceive_dropReceiveData=function(){return!1},ozpIwc.owf7ParticipantModules.Dd.prototype.hookReceive_dragStart=function(a){return this.participant.listener.inDrag=!0,!0},ozpIwc.owf7ParticipantModules.Dd.prototype.hookPublish_dragStart=function(a){return this.participant.listener.inDrag=!0,!0},ozpIwc.owf7ParticipantModules.Dd.prototype.hookReceive_dragStopInContainer=function(a){return this.participant.listener.inDrag=!1,!0},ozpIwc.owf7ParticipantModules.Dd.prototype.hookReceive_dragStopInWidget=function(){return this.participant.listener.inDrag=!1,!0},ozpIwc.owf7ParticipantModules.Dd.prototype.hookPublish_dragSendData=function(a){return this.dataApi.set(ozpIwc.owf7ParticipantModules.Dd.rpcChannel("_dragSendData_value"),{entity:a}),!1},ozpIwc.owf7ParticipantModules.Dd.prototype.hookPublish_dragStopInWidget=function(a){var b=this;return this.mouseOver?(this.dataApi.get(ozpIwc.owf7ParticipantModules.Dd.rpcChannel("_dragSendData_value")).then(function(a){gadgets.rpc.call(b.participant.rpcId,"pubsub",null,"_dropReceiveData","..",a.entity),b.dataApi.set(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("_dragStopInContainer"),{entity:Date.now()})}),!0):(this.onFakeMouseUpFromClient(this.lastPosition),window.setTimeout(function(){b.participant.listener.inDrag&&b.dataApi.set(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("_dragStopInContainer"),{entity:Date.now()})},250),!1)},ozpIwc=ozpIwc||{},ozpIwc.owf7ParticipantModules=ozpIwc.owf7ParticipantModules||{},ozpIwc.owf7ParticipantModules.Eventing=function(a){if(!a)throw"Needs to have an OWF7Participant";this.participant=a,this.participant.dd=this.participant.dd||{},this.dataApi=this.participant.client.data(),this.subscriptions={}},ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel=function(a){return"/owf-legacy/eventing/"+a},ozpIwc.owf7ParticipantModules.Eventing.prototype.onContainerInit=function(a,b){("undefined"===window.name||""===window.name)&&(window.name="ContainerWindowName"+Math.random());var c=gadgets.json.parse(b),d=c.useMultiPartMessagesForIFPC,e=this.participant.rpcId;gadgets.rpc.setRelayUrl(e,c.relayUrl,!1,d),gadgets.rpc.setAuthToken(e,0);var f='{"id":"'+window.name+'"}';gadgets.rpc.call(e,"after_container_init",null,window.name,f)},ozpIwc.owf7ParticipantModules.Eventing.prototype.onPubsub=function(a,b,c,d,e){switch(a){case"publish":this.onPublish(a,b,c,d,e);break;case"subscribe":this.onSubscribe(a,b,c,d);break;case"unsubscribe":this.onUnsubscribe(a,b,c,d)}},ozpIwc.owf7ParticipantModules.Eventing.prototype.onPublish=function(a,b,c,d,e){(!this.participant.dd["hookPublish"+b]||this.participant.dd["hookPublish"+b].call(this.participant.dd,c))&&this.dataApi.set(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel(b),{entity:{message:c,sender:e},lifespan:"ephemeral"})},ozpIwc.owf7ParticipantModules.Eventing.prototype.onSubscribe=function(a,b,c,d){this.subscriptions[b]=this.subscriptions[b]||{};var e=this;this.dataApi.watch(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel(b),{lifespan:"ephemeral"},function(a,c){e.subscriptions[b]=e.subscriptions[b]||{},e.subscriptions[b][a.replyTo]=c,(!e.participant.dd["hookReceive"+b]||e.participant.dd["hookReceive"+b].call(e.participant.dd,a.entity.newValue))&&gadgets.rpc.call(e.participant.rpcId,"pubsub",null,b,a.entity.newValue.sender,a.entity.newValue.message)})},ozpIwc.owf7ParticipantModules.Eventing.prototype.onUnsubscribe=function(a,b,c,d){this.subscriptions[b]=this.subscriptions[b]||[];for(var e in this.subscriptions[b])this.subscriptions[b][e]()},ozpIwc=ozpIwc||{},ozpIwc.owf7ParticipantModules=ozpIwc.owf7ParticipantModules||{},ozpIwc.owf7ParticipantModules.Intents=function(a){if(!a)throw"Needs to have an Owf7Participant";this.participant=a,this.intentsApi=this.participant.client.intents()},ozpIwc.owf7ParticipantModules.Intents.prototype.onIntents=function(a,b,c,d,e){if(b=b||{},!b.dataType)throw"A legacy intent registration requires a dataType.";if(!b.action)throw"A legacy intent registration requires an action.";this.intentsApi.invoke("/"+b.dataType+"/"+b.action,{entity:{entity:c,destIds:d,senderId:a}})},ozpIwc.owf7ParticipantModules.Intents.prototype.onIntentsReceive=function(a,b){if(a=a||{},!a.dataType)throw"A legacy intent registration requires a dataType.";if(!a.action)throw"A legacy intent registration requires an action.";this.intentsApi.register("/"+a.dataType+"/"+a.action,{entity:{type:a.dataType,action:a.action,icon:this.participant.appData.icons.small||"about:blank",label:this.participant.widgetParams.name||document.title},contentType:"application/vnd.ozp-iwc-intent-handler-v1+json"},function(a){var c=a.entity||{},d=a.intent||{},e=c.entity,f={action:d.action,dataType:d.type};gadgets.rpc.call(b,"_intents",null,e.senderId,f,e.entity)})},ozpIwc=ozpIwc||{},ozpIwc.owf7ParticipantModules=ozpIwc.owf7ParticipantModules||{},ozpIwc.owf7ParticipantModules.Kernel=function(a){if(!a)throw"Needs to have an Owf7Participant";this.participant=a,this.widgetReadyMap={},this.proxyMap={},this.dataApi=this.participant.client.data(),this.registerWidgetListing(),this.registerFunctionCallListener(),this.registerFunctionCallResultListener(),this.registerWidgetReadyListener(),this.registerDirectMessageListener()},ozpIwc.owf7ParticipantModules.Kernel.prototype.listWidgetChannel="/owf-legacy/kernel/_list_widgets",ozpIwc.owf7ParticipantModules.Kernel.prototype.widgetProxyChannelPrefix="/owf-legacy/kernel/proxy/",ozpIwc.owf7ParticipantModules.Kernel.prototype.widgetReadyResource=function(a){return this.widgetProxyChannelPrefix+a+"/_widgetReady"},ozpIwc.owf7ParticipantModules.Kernel.prototype.functionCallResource=function(a){return this.widgetProxyChannelPrefix+a+"/FUNCTION_CALL_CLIENT"},ozpIwc.owf7ParticipantModules.Kernel.prototype.functionCallResultResource=function(a){return this.widgetProxyChannelPrefix+a+"/FUNCTION_CALL_RESULT_CLIENT"},ozpIwc.owf7ParticipantModules.Kernel.prototype.directMessageResource=function(a){return this.widgetProxyChannelPrefix+a+"/DIRECT_MESSAGE"},ozpIwc.owf7ParticipantModules.Kernel.prototype.callEventResource=function(a){return this.widgetProxyChannelPrefix+"/CALL_EVENT/"+a},ozpIwc.owf7ParticipantModules.Kernel.prototype.registerWidgetReadyListener=function(){var a=this;this.dataApi.set(this.widgetReadyResource(this.participant.instanceId),{lifespan:"ephemeral"}),this.dataApi.watch(this.widgetReadyResource(this.participant.instanceId),function(b,c){c(),a.onWidgetReady(a.participant.instanceId)})},ozpIwc.owf7ParticipantModules.Kernel.prototype.registerWidgetListing=function(){var a=this;window.addEventListener("beforeunload",function(){a.unregisterWidgetListing()}),this.dataApi.addChild(this.listWidgetChannel,{entity:gadgets.json.parse(this.participant.rpcId),lifespan:"ephemeral"}).then(function(b){a.widgetListing=b.entity.resource})},ozpIwc.owf7ParticipantModules.Kernel.prototype.unregisterWidgetListing=function(){return this.dataApi.removeChild(this.listWidgetChannel,{entity:{resource:this.widgetListing}}),!0},ozpIwc.owf7ParticipantModules.Kernel.prototype.onGetWidgetReady=function(a,b){if(this.widgetReadyMap.hasOwnProperty(a))b.callback(this.widgetReadyMap[a]===!0);else{var c=this;this.dataApi.get(this.widgetReadyResource(a)).then(function(d){var e=!!d.entity;e&&c.onWidgetReady(a),b.callback(e)},function(a){"noResource"===a.response&&b.callback(!1)})}},ozpIwc.owf7ParticipantModules.Kernel.prototype.onWidgetReady=function(a){this.widgetReadyMap[a]=!0,this.dataApi.set(this.widgetReadyResource(a),{entity:this.widgetReadyMap[a],lifespan:"ephemeral"});var b=this.proxyMap[a];if(b)for(var c=0,d=b.length;d>c;c++){var e=b[c];e&&this.dataApi.set(this.widgetReadyResource(e),{entity:!0,lifespan:"ephemeral"})}},ozpIwc.owf7ParticipantModules.Kernel.prototype.onRegisterFunctions=function(a,b){var c=JSON.parse(a).id,d=this;this.dataApi.get(this.widgetProxyChannelPrefix+c).then(function(a){return Array.isArray(a.entity)?a.entity:[]},function(a){return"noResource"===a.response?[]:void 0}).then(function(a){for(var e in b)a.indexOf(b[e])<0&&a.push(b[e]);d.dataApi.set(d.widgetProxyChannelPrefix+c,{entity:a,lifespan:"ephemeral"})})},ozpIwc.owf7ParticipantModules.Kernel.prototype.onGetFunctions=function(a,b,c){var d=this;this.dataApi.get(this.widgetProxyChannelPrefix+a).then(function(e){if(d.proxyMap[a]||(d.proxyMap[a]=[]),b){var f=JSON.parse(b).id;d.proxyMap[a].push(f)}c.callback(e.entity)},function(a){"noResource"===a.response&&c.callback([])})},ozpIwc.owf7ParticipantModules.Kernel.prototype.onFunctionCall=function(a,b,c,d){this.dataApi.set(this.functionCallResource(a),{entity:{widgetId:a,widgetIdCaller:b,functionName:c,var_arg:d,time:Date.now()},lifespan:"ephemeral"})},ozpIwc.owf7ParticipantModules.Kernel.prototype.functionCallClient=function(a,b,c,d){gadgets.rpc.call(this.participant.rpcId,"FUNCTION_CALL_CLIENT",null,a,b,c,d)},ozpIwc.owf7ParticipantModules.Kernel.prototype.functionCallResultClient=function(a,b,c,d){gadgets.rpc.call(this.participant.rpcId,"FUNCTION_CALL_RESULT_CLIENT",null,a,c,d)},ozpIwc.owf7ParticipantModules.Kernel.prototype.onFunctionCallResult=function(a,b,c,d){this.dataApi.set(this.functionCallResultResource(b),{entity:{widgetId:a,widgetIdCaller:b,functionName:c,result:d,time:Date.now()},lifespan:"ephemeral"})},ozpIwc.owf7ParticipantModules.Kernel.prototype.registerFunctionCallListener=function(){var a=this;this.dataApi.watch(this.functionCallResource(this.participant.instanceId),function(b){var c=b.entity.newValue.widgetId||"",d=b.entity.newValue.widgetIdCaller||"",e=b.entity.newValue.functionName||"",f=b.entity.newValue.var_arg||[];a.functionCallClient(c,d,e,f)})},ozpIwc.owf7ParticipantModules.Kernel.prototype.registerFunctionCallResultListener=function(){var a=this;this.dataApi.watch(this.functionCallResultResource(this.participant.instanceId),function(b){var c=b.entity.newValue.widgetId||"",d=b.entity.newValue.widgetIdCaller||"",e=b.entity.newValue.functionName||"",f=b.entity.newValue.result||{};a.functionCallResultClient(c,d,e,f)})},ozpIwc.owf7ParticipantModules.Kernel.prototype.onListWidgets=function(a){var b=this;this.dataApi.list(this.listWidgetChannel).then(function(c){var d=[],e=c.entity.length||0,f=function(b){b.entity&&b.entity.id&&d.push(b.entity),--e<=0&&a.callback(d)};for(var g in c.entity)b.dataApi.get(c.entity[g]).then(f)})},ozpIwc.owf7ParticipantModules.Kernel.prototype.onDirectMessage=function(a,b){this.dataApi.set(this.directMessageResource(a),{entity:{message:b,ts:ozpIwc.util.now()},lifespan:"ephemeral"})},ozpIwc.owf7ParticipantModules.Kernel.prototype.registerDirectMessageListener=function(){var a=this;this.dataApi.watch(this.directMessageResource(this.participant.instanceId),function(b){if(b.entity&&b.entity.newValue&&b.entity.newValue.message){var c=b.entity.newValue.message;a.directMessageClient(c)}})},ozpIwc.owf7ParticipantModules.Kernel.prototype.directMessageClient=function(a){gadgets.rpc.call(this.participant.rpcId,"DIRECT_MESSAGEL_CLIENT",null,a)},ozpIwc.owf7ParticipantModules.Kernel.prototype.onAddEvent=function(a,b){var c=this;this.dataApi.watch(this.callEventResource(b),function(a){a.entity&&a.entity.newValue&&a.entity.newValue.message&&c.eventClient(b,a.entity.newValue.message)})},ozpIwc.owf7ParticipantModules.Kernel.prototype.eventClient=function(a,b){gadgets.rpc.call(this.participant.rpcId,"EVENT_CLIENT",null,a,b)},ozpIwc.owf7ParticipantModules.Kernel.prototype.onCallEvent=function(a,b){this.dataApi.set(this.callEventResource(a),{entity:{message:b,ts:ozpIwc.util.now()},lifespan:"ephemeral"})},ozpIwc=ozpIwc||{},ozpIwc.owf7ParticipantModules=ozpIwc.owf7ParticipantModules||{},ozpIwc.owf7ParticipantModules.Util=function(a){if(!a)throw"Needs to have an Owf7Participant";this.participant=a,this.dataApi=this.participant.client.data(),this.registerLogging()},ozpIwc.owf7ParticipantModules.Util.prototype.registerLogging=function(){this.dataApi.watch(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("Ozone.log"),function(a){var b=a.entity.newValue.message;gadgets.rpc.call("..","Ozone.log",null,b),ozpIwc.log.debug("[Legacy]",b)})},ozpIwc.owf7ParticipantModules.Util.prototype.onOzoneLog=function(a){this.dataApi.set(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("Ozone.log"),{entity:{message:a,ts:ozpIwc.util.now()}})},ozpIwc.Owf7Participant=function(a){if(a=a||{},!a.listener)throw"Needs to have an OWF7ParticipantListener";if(!a.client)throw"Needs an IWC Client";if(!a.guid)throw"Must be assigned a guid for this widget";if(!a.instanceId)throw"Needs an widget instance id";if(!a.url)throw"Needs a url for the widget";if(!a.rpcId)throw"Needs a rpcId for the widget";this.iframe=a.iframe,this.listener=a.listener,this.client=a.client,this.systemApi=this.client.system(),this.intentsApi=this.client.intents(),this.url=a.url,this.instanceId=a.instanceId,this.widgetGuid=a.guid,this.rpcId=a.rpcId,this.onReady=a.onReady,this.widgetQuery="?lang=en_US&owf=true&themeName=a_default&themeContrast=standard&themeFontSize=12",this.launchData=a.launchData||{},this.appData={},this.iframe=document.createElement("iframe"),this.iframe.id=a.instanceId,this._initModules(),a.externalInit||this.connect(a.launchData)},ozpIwc.Owf7Participant.prototype._initModules=function(){this.dd=new ozpIwc.owf7ParticipantModules.Dd(this),this.eventing=new ozpIwc.owf7ParticipantModules.Eventing(this),this.kernel=new ozpIwc.owf7ParticipantModules.Kernel(this),this.components=new ozpIwc.owf7ParticipantModules.Components(this),
this.intents=new ozpIwc.owf7ParticipantModules.Intents(this),this.util=new ozpIwc.owf7ParticipantModules.Util(this)},ozpIwc.Owf7Participant.prototype.connect=function(){if(!this.connectPromise){var a=this,b=function(b){a.appData=b||{},a.setWidgetTitle(a.appData.name),a.iframe.setAttribute("name",JSON.stringify(a.widgetParams)),a.iframe.setAttribute("src",a.widgetParams.url+a.widgetQuery),a.iframe.setAttribute("id",a.rpcId);var c=document.body.appendChild(a.iframe),d=function(){c.style.pointerEvents="auto",c.removeEventListener("mousemove",d)};document.addEventListener("mousemove",d),"function"==typeof a.onReady&&a.onReady()};this.connectPromise=new Promise(function(b,c){a.widgetParams={id:a.instanceId,webContextPath:"/owf",preferenceLocation:a.listener.prefsUrl,relayUrl:a.listener.rpcRelay,url:a.url,guid:a.widgetGuid,layout:"desktop",containerVersion:"7.0.1-GA",owf:!0,lang:"en_US",currentTheme:{themeName:"a_default",themeContrast:"standard",themeFontSize:12},version:1,locked:!1,data:a.launchData},b(a._getApplicationData())}).then(function(a){b(a)})}return this.connectPromise},ozpIwc.Owf7Participant.prototype._getApplicationData=function(){var a={icons:{small:"about:blank",large:"about:blank",banner:"about:blank",featuredBanner:"about:blank"},intents:[],name:null};return this.systemApi.get("/application/"+this.widgetGuid).then(function(b){return b.entity&&b.entity.icons?b.entity:a})["catch"](function(b){return a})},ozpIwc.Owf7Participant.prototype.setWidgetTitle=function(a){if(!a){var b=document.createElement("a");b.href=this.widgetParams.url,a=b.host+b.pathname+" -- OWF Widget"}return document.title=a,document.title},function(){var a=function(a){var b=document.createElement("a");return b.href=a,b.protocol+"//"+b.host+b.pathname+b.search+b.hash};ozpIwc.Owf7ParticipantListener=function(b){b=b||{},this.rpcRelay=a(b.rpcRelay||"rpc_relay.uncompressed.html"),this.prefsUrl=a(b.prefsUrl||ozpIwc.owf7PrefsUrl||"/owf/prefs"),this.participants={},this.client=new ozpIwc.ClientParticipant,this.client.connect(),this.dataApi=this.client.data(),this.bridge=b.bridge||new ozpIwc.Owf7Bridge({listener:this}),("undefined"===window.name||""===window.name)&&(window.name="ContainerWindowName"+Math.random()),this.installDragAndDrop(),this.xOffset="number"==typeof b.xOffset?b.xOffset:window.screenX+window.outerWidth-window.innerWidth+10,this.yOffset="number"==typeof b.yOffset?b.yOffset:window.screenY+window.outerHeight-window.innerHeight+26},ozpIwc.Owf7ParticipantListener.prototype.makeGuid=function(){var a=function(){return(65536*(1+Math.random())|0).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},ozpIwc.Owf7ParticipantListener.prototype.updateMouseCoordinates=function(a){this.xOffset=a.screenX-a.clientX,this.yOffset=a.screenY-a.clientY},ozpIwc.Owf7ParticipantListener.prototype.convertToLocalCoordinates=function(a,b){var c={};for(var d in a)c[d]=a[d];for(c.pageX=a.screenX-this.xOffset,c.pageY=a.screenY-this.yOffset;b;)c.pageX+=b.offsetLeft-b.scrollLeft+b.clientLeft,c.pageY+=b.offsetTop-b.scrollTop+b.clientTop,b=b.offsetParent;return c},ozpIwc.Owf7ParticipantListener.prototype.addWidget=function(a){function b(a){var b={},d="#";a.guid&&(b.guid=a.guid),a.instanceId&&(b.instanceId=a.instanceId);for(var e in b)d+=e+"="+b[e]+"&";d=d.substring(0,d.length-1),window.location.hash=d,a.guid=a.guid||a.instanceId,c.participants[a.instanceId]=new ozpIwc.Owf7Participant(a);var f={state:{}};return f.state["_WIDGET_STATE_CHANNEL_"+a.instanceId]=function(){},c.bridge.addHandlers(f),a.listener.participants[a.instanceId].connect().then(function(){return a.listener.participants[a.instanceId]})}a=a||{};var c=this,d={};for(var e in a)d[e]=a[e];return d.instanceId=a.instanceId||this.makeGuid(),d.listener=c,d.client=this.client,d.rpcId=gadgets.json.stringify({id:d.instanceId}),a.launchData&&(d.guid=a.launchData.id),b(d)},ozpIwc.Owf7ParticipantListener.prototype.cancelDrag=function(){this.inDrag=!1,this.dataApi.set(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("_dragStopInContainer"),{entity:Date.now()})},ozpIwc.Owf7ParticipantListener.prototype.installDragAndDrop=function(){var a=this;this.inDrag=!1;var b=function(b){a.updateMouseCoordinates(b)};document.addEventListener("mouseenter",b),document.addEventListener("mouseout",b),this.dataApi.watch(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("_dragStart"),function(b){a.inDrag=!0}),this.dataApi.watch(ozpIwc.owf7ParticipantModules.Eventing.pubsubChannel("_dragStopInContainer"),function(b){a.inDrag=!1}),document.addEventListener("mousemove",function(b){a.updateMouseCoordinates(b),a.inDrag&&0!==b.button&&(console.log("Canceling drag"),a.cancelDrag())},!1)},ozpIwc.Owf7ParticipantListener.prototype.getParticipant=function(a){var b;try{b=JSON.parse(a).id}catch(c){b=a}return this.participants[b]}}();
//# sourceMappingURL=ozp-iwc-owf7-widget-adapter.min.js.map